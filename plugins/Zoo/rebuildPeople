#!/usr/bin/perl -w
# This code is a part of Slash, and is released under the GPL.
# Copyright 1997-2002 by Open Source Development Network. See README
# and COPYING for more information, or see http://slashcode.com/.
# $Id: rebuildPeople,v 1.15 2003/02/06 05:26:17 brian Exp $

use strict;
use File::Basename;
use Getopt::Std;
use Slash;
use Slash::DB;
use Slash::Utility;
use Slash::Constants ':people';

use vars qw( $slashdb $werder $constants $junk );

(my $VERSION) = ' $Revision: 1.15 $ ' =~ /\$Revision:\s+([^\s]+)/;
my $PROGNAME = basename($0);

my %opts;
# Remember to doublecheck these match usage()!
usage('Options used incorrectly') unless getopts('hu:v', \%opts);
usage() if $opts{'h'};
$opts{'u'} ||= 'slash';

createEnvironment($opts{u});
$slashdb = getCurrentDB();
$constants = getCurrentStatic();

# First clean up fans/freaks
$slashdb->sqlDo("UPDATE people SET perceive=NULL");
$slashdb->sqlDo("DELETE FROM people WHERE type IS NULL");

# Put in blanks
$slashdb->sqlDo("CREATE TEMPORARY TABLE people_select SELECT person,uid FROM people WHERE type IS NOT NULL");
$slashdb->sqlDo("INSERT IGNORE INTO people (uid,person) SELECT * from people_select");
$slashdb->sqlDo("DROP TABLE people_select");

# Put back fans
$slashdb->sqlDo(qq|SELECT CONCAT("UPDATE people SET perceive='fan' WHERE uid =", person, " AND person =", uid, ";") INTO OUTFILE '/tmp/rebuildpeople-fan.sql' FROM people WHERE type='friend'|);
$slashdb->sqlDo("source /tmp/rebuildpeople-fan.sql");

# Put back freaks
$slashdb->sqlDo(qq|SELECT CONCAT("UPDATE people SET perceive='freak' WHERE uid =", person, " AND person =", uid, ";") INTO OUTFILE '/tmp/rebuildpeople-freak.sql' FROM people WHERE type='foe'|);
$slashdb->sqlDo("source /tmp/rebuildpeople-freak.sql");

# 
my $people = $slashdb->sqlSelectColArrayref('DISTINCT uid', 'people');

my $zoo = getObject("Slash::Zoo");
for (@$people) {
	my $people = $zoo->rebuildUser($_);
	$slashdb->setUser($_, { people => $people});

}

sub usage {
	print "*** $_[0]\n" if $_[0];
	# Remember to doublecheck these match getopts()!
	print <<EOT;

Usage: $PROGNAME [OPTIONS] [#users]

This rebuilds the people table for the Zoo system.

Main options:
	-h	Help (this message)
	-v	Version
	-u	Virtual user (default is "slash")

EOT
	exit;
}


sub version {
	print <<EOT;

$PROGNAME $VERSION

This code is a part of Slash, and is released under the GPL.
Copyright 1997-2002 by Open Source Development Network. See README
and COPYING for more information, or see http://slashcode.com/.

EOT
	exit;
}
