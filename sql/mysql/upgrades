# This is the upgrade file for SQL. What does this mean to you?
# If you are a developer you should leave notes here as to what
# was done and when. This includes inserts, alter tables and deletions.
# The Format is that you add your changes to the end with notes
# and who you are. If your changes occur after a certain release tag
# then you need to place your changes there.

# (from sometime prior to when we had this file)
ALTER TABLE users_info DROP COLUMN hits;

# LCR 2/7, 10PM T_2_3_0_9 

# To fix the data in users to add the + sign to positive values -Brian
UPDATE users_param SET value = CONCAT("+",value) WHERE (name LIKE "reason%" OR name LIKE "people_bonus%") AND value LIKE "_";

# Upgrade Zoo to latest schema, once you do this run the rebuildPeople script 
# in the plugin. -Brian
CREATE TABLE temp_zoo SELECT * FROM people;
DROP TABLE IF EXISTS people;
CREATE TABLE people (
  id MEDIUMINT UNSIGNED NOT NULL auto_increment,
  uid MEDIUMINT UNSIGNED NOT NULL,
  person MEDIUMINT UNSIGNED NOT NULL,
  type enum("friend","foe"),
  perceive enum("fan","freak"),
  fof MEDIUMINT UNSIGNED NOT NULL  DEFAULT 0, 
  eof MEDIUMINT UNSIGNED NOT NULL  DEFAULT 0,
  UNIQUE degree_of_separation (uid,person),
  PRIMARY KEY (id)
);
INSERT INTO people (uid,person,type) SELECT uid, person, type from temp_zoo;


# This was removed from the bonus system a while ago. -Brian
ALTER TABLE users_comments DROP anon_comments;

# Changes for sections
# Make sure you run install-plugin for sections and delete the old sections.pl from your 
# slashcode theme. -Brian
ALTER TABLE sections ADD url char(32) DEFAULT '' NOT NULL;
ALTER TABLE sections ADD hostname char(32)DEFAULT '' NOT NULL;

# Well we didn't need either of these two indexes. We got the same data from two
# other rows. -Brian
ALTER TABLE comments DROP INDEX uid;
ALTER TABLE comments DROP INDEX sid;
# More key stuff. We had a number of duplicate keys in 
# users. I should really spend time and go through the 
# entire schema. -Brian
ALTER TABLE users DROP INDEX login;
ALTER TABLE users ADD INDEX login (nickname,uid,passwd);
ALTER TABLE users DROP INDEX chk4user;
ALTER TABLE users ADD INDEX chk4user (realemail,nickname);
ALTER TABLE users DROP INDEX nickname_lookup;
ALTER TABLE users DROP INDEX chk4email;
# Few more.
ALTER TABLE moderatorlog DROP INDEX sid_2;
ALTER TABLE moderatorlog ADD INDEX sid_2 (cid,uid,sid);
ALTER TABLE moderatorlog DROP INDEX cid;

# new multi topics stuff
DROP TABLE IF EXISTS story_topics;
CREATE TABLE story_topics (
  id int(5) NOT NULL auto_increment,
  sid varchar(16) NOT NULL default '',
  tid smallint(5) unsigned default NULL,
  FOREIGN KEY (sid) REFERENCES stories(sid),
  FOREIGN KEY (tid) REFERENCES topics(tid),
  PRIMARY KEY  (id),
  INDEX sid (sid),
  INDEX tid (tid)
) TYPE=MyISAM;

# New var to regulate comment display - Jamie
INSERT INTO vars (name, value, description) VALUES ('comments_max_email_len','40','Max num of chars of fakeemail to display in comment header');

# End of T_2_3_0_10, Start of T_2_3_0_11

# New attribute for stories
ALTER TABLE stories ADD day_published date DEFAULT '0000-00-00' NOT NULL;
ALTER TABLE stories ADD INDEX published (day_published);
UPDATE stories SET day_published=time;
INSERT INTO vars (name, value, description) VALUES ('comments_moddable_archived','0','Are comments in discussions that have been archived moderatable?');
INSERT INTO vars (name, value, description) VALUES ('comments_moddable_hours','336','Num hours after being posted that a comment may be moderated');

# End of T_2_3_0_?, Start of R_2_3_0_13

# This was added to sql/mysql/slashschema_create.sql ... but is NOT yet live.
# Brian says "list" is being yanked and "type" is part of code that PatG
# hasn't yet committed, so I'm ignoring it for now... this is here in
# upgrades as a reminder.
# added new column to section_extras to accomodate pulldows 
# (key/values stored in string_param)
ALTER TABLE section_extras add column type enum("text","list") DEFAULT 'text' NOT NULL;
ALTER TABLE string_param modify column code varchar(32) NOT NULL; 

# End of R_2_3_0_13, Start of T_2_3_0_14

ALTER TABLE users_hits ADD COLUMN hits_bought_today SMALLINT UNSIGNED DEFAULT 0 NOT NULL AFTER hits_bought;
ALTER TABLE sessions add column last_subid varchar(15);
ALTER TABLE sessions add column last_sid varchar(16);

# End of R_2_3_0_14, Start of T_2_3_0_15

# add ECODE tag ...
UPDATE vars SET value=CONCAT(value,'|ECODE') WHERE name='approvedtags';

# Message threshold
INSERT INTO vars (name, value, description) VALUES ('message_threshold','1','Default threshold for a comment to trigger a message');

# End of R_2_3_0_15, Start of T_2_3_0_16

# Browser bug workaround
INSERT INTO vars (name, value, description) VALUES ('comment_nonstartwordchars','.,;:/','Chars which cannot start a word (will be forcibly separated from the rest of the word by a space) - this works around a Windows/MSIE "widening" bug - set blank for no action');

# Size changes and new column -Brian
ALTER TABLE sections CHANGE url url varchar(128) DEFAULT '' NOT NULL;
ALTER TABLE sections CHANGE hostname hostname varchar(128) DEFAULT '' NOT NULL;
ALTER TABLE sections ADD cookiedomain varchar(128) DEFAULT '' NOT NULL;
# freshenup.pl chunks article .shtml files
INSERT INTO vars (name, value, description) VALUES ('freshenup_max_stories','100','Maximum number of article.shtml files to write at a time in freshenup.pl');

# Start of T_2_3_0_20

# New hooks table
DROP TABLE IF EXISTS hooks;
CREATE TABLE hooks (
   id mediumint(5) UNSIGNED NOT NULL auto_increment,
   param varchar(50) DEFAULT '' NOT NULL,
   class varchar(100) DEFAULT '' NOT NULL,
   subroutine varchar(100) DEFAULT '' NOT NULL,
   PRIMARY KEY (id),
   UNIQUE hook_param (param,class,subroutine)
) TYPE = myisam;

ALTER TABLE stories ADD COLUMN qid MEDIUMINT UNSIGNED DEFAULT NULL;

# Same as below
#perl -MSlash::Test=virtusername -le '$qs = $slashdb->sqlSelectAllHashrefArray("pollquestions.qid AS qid, pollquestions.sid AS sid", "pollquestions, stories", "pollquestions.sid=stories.sid"); for my $hr (@$qs) { my($q,$s) = ($hr->{qid}, $hr->{sid}); my $sq=$slashdb->sqlQuote($s); print "$q -> $s"; $slashdb->sqlUpdate("stories", { qid => $q }, "sid=$sq") or die "\tFAILED" }'
# I have never tried to do a "source" from a file but I suspect it will work -Brian
select CONCAT('UPDATE stories SET qid=',qid,' WHERE sid="',sid,'";') into outfile "/tmp/pollquestions.sql" from pollquestions;
source /tmp/pollquestions.sql

# (and, once we're convinced everything works)
ALTER TABLE pollquestions DROP COLUMN sid;

# End of T_2_3_0_20, Start of T_2_3_0_21

# New submission_param table
DROP TABLE IF EXISTS submission_param;
CREATE TABLE submission_param (
   param_id mediumint UNSIGNED NOT NULL auto_increment,
   subid varchar(15) NOT NULL,
   name varchar(32) DEFAULT '' NOT NULL,
   value text DEFAULT '' NOT NULL,
   UNIQUE submission_key (subid,name),
   PRIMARY KEY (param_id)
) TYPE = myisam;

# This is the multi section topic stuff for Foundries
INSERT INTO code_param (type, code, name) VALUES ('section_topic_types',1,'default');
ALTER TABLE section_topics ADD COLUMN type smallint UNSIGNED NOT NULL;
UPDATE section_topics SET type=1;

ALTER TABLE section_extras MODIFY COLUMN type ENUM("text","list","topics") DEFAULT 'text' NOT NULL;

# Autopoll update
ALTER TABLE pollquestions ADD COLUMN autopoll enum("no","yes") DEFAULT 'no' NOT NULL;

# Submissions
ALTER TABLE submissions ADD COLUMN weight float DEFAULT '0' NOT NULL;

#New index_handler bits
INSERT INTO vars (name, value, description) VALUES ('index_handler','index.pl','The perl servlet to call for conections to the root of the server.');
ALTER TABLE sections ADD COLUMN index_handler varchar(30) DEFAULT "index.pl" NOT NULL;
ALTER TABLE sections ADD COLUMN writestatus ENUM("ok","dirty") DEFAULT 'ok' NOT NULL;

#slashd_log table
INSERT INTO menus (menu, label, value, seclev, menuorder) VALUES ('admin','Slashd','[% constants.rootdir %]/admin.pl?op=slashd',500,17);

# Note this is different than what Brian committed Wednesday morning;
# were any sites updated with that?
DROP TABLE IF EXISTS slashd_status;
CREATE TABLE slashd_status (
   task varchar(50) NOT NULL default '',
   next_begin DATETIME,
   in_progress TINYINT NOT NULL DEFAULT '0',
   last_completed DATETIME,
   summary VARCHAR(255) NOT NULL DEFAULT '',
   duration float(6,2) DEFAULT '0.00' NOT NULL,
   PRIMARY KEY  (task)
) TYPE=MyISAM;

# Remember pollBooth is now a plugin!

# Unique changes for Pat
ALTER TABLE section_topics DROP PRIMARY KEY;
ALTER TABLE section_topics ADD PRIMARY KEY (section,type,tid);
INSERT INTO string_param (type, code, name) VALUES ('yes_no','yes','yes');
INSERT INTO string_param (type, code, name) VALUES ('yes_no','no','no');
INSERT INTO vars (name, value, description) VALUES ('label_ui','0','Whether to label some things in the admin ui');
INSERT INTO vars (name, value, description) VALUES ('enable_index_topic','','set this to the value in string param for index topic \(something like "topic_4"\)');
INSERT INTO vars (name, value, description) VALUES ('get_titles','0','get the story titles');
INSERT INTO vars (name, value, description) VALUES ('organise_stories','','organise story blocks');
INSERT INTO string_param (Type, code, name) VALUES ('section_topic_type','topic_1','Default');

# another small change for topic types
ALTER TABLE section_topics MODIFY COLUMN type varchar(16) NOT NULL DEFAULT 'topic_1';
UPDATE section_topics SET type = 'topic_1' WHERE type = '1';

# Change for plugins/Subscribe
ALTER TABLE subscribe_payments ADD COLUMN method VARCHAR(6) AFTER transaction_id;

ALTER TABLE comments DROP index countreplies;
ALTER TABLE comments ADD KEY countreplies (pid,sid);
# Not read just yet but I am leaving it here as a note -Brian
ALTER TABLE blocks ADD autosubmit enum("no","yes") DEFAULT 'no' NOT NULL;
INSERT INTO vars (name, value, description) VALUES ('rss_store','0','Should we be saving incomming submissions for rss');
INSERT INTO vars (name, value, description) VALUES ('rss_expire_days','7','Number of days till we blank the data from the database (the signatures still stick around though)');
ALTER TABLE submissions DROP subid;
ALTER TABLE submissions ADD subid mediumint UNSIGNED NOT NULL PRIMARY KEY auto_increment;
ALTER TABLE sessions DROP last_subid;
ALTER TABLE sessions ADD last_subid mediumint UNSIGNED;
DROP TABLE IF EXISTS submission_param;
CREATE TABLE submission_param (
   param_id mediumint UNSIGNED NOT NULL auto_increment,
   subid mediumint UNSIGNED NOT NULL,
   name varchar(32) DEFAULT '' NOT NULL,
   value text DEFAULT '' NOT NULL,
   UNIQUE submission_key (subid,name),
   PRIMARY KEY (param_id)
) TYPE = myisam;
INSERT INTO string_param (type, code, name) VALUES ('yes_no','yes','yes');
INSERT INTO string_param (type, code, name) VALUES ('yes_no','no','no');
DROP TABLE IF EXISTS rss_raw;
CREATE TABLE rss_raw (
   id mediumint UNSIGNED NOT NULL auto_increment,
   link_signature char(32) DEFAULT '' NOT NULL,
   title_signature char(32) DEFAULT '' NOT NULL,
   description_signature char(32) DEFAULT '' NOT NULL,
   link varchar(255) NOT NULL,
   title varchar(255) NOT NULL,
   description varchar(255) NOT NULL,
   subid mediumint UNSIGNED,
   bid varchar(30),
   created datetime, 
   processed enum("no","yes") DEFAULT 'no' NOT NULL,
   UNIQUE uber_signature (link_signature, title_signature, description_signature),
   FOREIGN KEY (subid) REFERENCES submissions(subid),
   FOREIGN KEY (bid) REFERENCES blocks(bid),
   PRIMARY KEY (id)
) TYPE = myisam;

# A nice useful var.
INSERT INTO vars (name, value, description) VALUES ('admin_formkeys', '0', 'Do admins have to bother with formkeys?');

# End of T_2_3_0_21, Start of T_2_3_0_22

# Install GD.pm and associated libraries for plugins/HumanConf.
# GD/Text and GD/Text/Align.pm are needed too.
# These Debian packages are believed necessary:
# libfreetype6-dev libfreetype6 freetype2 libjpeg62-dev libjpeg62
# when building from source, I used freetype-2.1.0, libpng-1.2.2,
# jpeg-6b, and gd-1.8.4, and the GD module from the CPAN. -- pudge
# last night Cliff and I got it to work on Debian stable using
# libjpeg62(-dev) and xpm4g(-dev) debs, plus source compiles of
# freetype-2.1.0 and gd-1.8.4; GD had 1 error (#8) and GD::Text
# had several errors, but after force installing, they work OK
# for HumanConf purposes.

# Add signature column to submissions. Be aware that this column's final
# state does not have a default.
ALTER TABLE submissions ADD COLUMN signature varchar(32) DEFAULT '' NOT NULL;
ALTER TABLE submissions ADD UNIQUE story_signature(signature);
UPDATE submissions SET signature=MD5(story);
ALTER TABLE submissions MODIFY COLUMN signature varchar(32) NOT NULL;

# This expands blocks to get data from sites that require logins via a cookie
ALTER TABLE blocks ADD COLUMN rss_cookie varchar(255);

#We ran into URLs that were longer then 50 characters 
ALTER TABLE submissions MODIFY COLUMN email varchar(255) DEFAULT '' NOT NULL;

UPDATE vars SET value=100 WHERE name="authors_unlimited";

#Needed for search, not used in submissions "yet"
INSERT INTO string_param (type, code, name) VALUES ('submission-notes','','Unclassified');
INSERT INTO string_param (type, code, name) VALUES ('submission-notes','Hold','Hold');
INSERT INTO string_param (type, code, name) VALUES ('submission-notes','Quick','Quick');
INSERT INTO string_param (type, code, name) VALUES ('submission-notes','Back','Back');

#
# Table structure for table 'subsections'
#

DROP TABLE IF EXISTS subsections;
CREATE TABLE subsections (
  id smallint UNSIGNED NOT NULL auto_increment,
  title varchar(30) NOT NULL,
  section varchar(30) NOT NULL,
  artcount mediumint DEFAULT '30' NOT NULL,
  UNIQUE code_key (title,section),
  FOREIGN KEY (section) REFERENCES sections(section),
  PRIMARY KEY (id)
) TYPE = myisam;

# End of T_2_3_0_22, Start of T_2_3_0_23

# If using HumanConf...
ALTER TABLE humanconf_pool ADD COLUMN inuse TINYINT DEFAULT '0' NOT NULL AFTER lastused;

ALTER TABLE stories ADD subsection SMALLINT UNSIGNED DEFAULT 0 NOT NULL;
ALTER TABLE sections DROP feature_story;
# LINUX.COM
ALTER TABLE accesslog ADD bytes mediumint UNSIGNED DEFAULT 0 NOT NULL;
INSERT INTO message_codes (code, type, seclev, modes) VALUES (10, 'Daily Site Stats', 100, '');

ALTER TABLE discussions ADD last_update timestamp;
ALTER TABLE stories ADD last_update timestamp;
# OSDN LAST UPDATED HERE

# End of R_2_3_0_23, Start of T_2_3_0_25
# (we skipped _24 due to an earlier glitch)

INSERT INTO vars (name, value, description) VALUES ('recent_topic_img_count','5','Number of recent topics to store in the template "recentTopics"');
INSERT INTO vars (name, value, description) VALUES ('recent_topic_txt_count','5','Number of recent topics to store in the block "recenttopics"');


# For plugins/Admin
INSERT INTO vars (name, value, description) VALUES ('similarstorydays', '30', 'Number of days to look back for uncommon words');
INSERT INTO vars (name, value, description) VALUES ('similarstorymaxwords', '30', 'Maximum number of top-weighted scores to search for in previous stories');
INSERT INTO vars (name, value, description) VALUES ('similarstoryminweight', '4', 'Minimum weight necessary for a story to be displayed as similar');
INSERT INTO vars (name, value, description) VALUES ('similarstorynumshow', '5', 'Maximum number of similar stories to show in admin preview');
INSERT INTO vars (name, value, description) VALUES ('uncommonstorywords', '', 'Uncommon words found in recent stories');
INSERT INTO vars (name, value, description) VALUES ('uncommonstorywords_maxlen', '65000', 'Maximum length of the uncommon words list');
INSERT INTO vars (name, value, description) VALUES ('uncommonstoryword_minlen', '3', 'Minimum length of the words in the uncommon words list');
INSERT INTO vars (name, value, description) VALUES ('uncommonstoryword_thresh', '2', 'Words occurring more often than once every this-many days are considered common');

# and this is not a DB command but needs to be done for
# each installed site that uses plugins/Admin:
# ln -s /usr/local/slash/plugins/Admin/refresh_uncommon.pl /usr/local/slash/site/sitename/tasks/

# Added for Pat for discussions -Brian
ALTER TABLE discussions ADD approved tinyint UNSIGNED DEFAULT 0 NOT NULL;
INSERT INTO vars (name, value, description) VALUES ('discussion_approval', '0', 'If this is set to 1, set all user created discussions when created to 0 so that they must be approved');
# For pudge -brian
ALTER TABLE templates ADD last_update timestamp;

# USEPERL LAST UPDATED HERE
# SLASHCODE LAST UPDATED HERE

# Added for some Calendar stuff I am working on -Brian
INSERT INTO code_param (type, code, name) VALUES ('months',1,'January');
INSERT INTO code_param (type, code, name) VALUES ('months',2,'Febuary');
INSERT INTO code_param (type, code, name) VALUES ('months',3,'March');
INSERT INTO code_param (type, code, name) VALUES ('months',4,'April');
INSERT INTO code_param (type, code, name) VALUES ('months',5,'May');
INSERT INTO code_param (type, code, name) VALUES ('months',6,'June');
INSERT INTO code_param (type, code, name) VALUES ('months',7,'July');
INSERT INTO code_param (type, code, name) VALUES ('months',8,'August');
INSERT INTO code_param (type, code, name) VALUES ('months',9,'September');
INSERT INTO code_param (type, code, name) VALUES ('months',10,'October');
INSERT INTO code_param (type, code, name) VALUES ('months',11,'November');
INSERT INTO code_param (type, code, name) VALUES ('months',12,'December');

# SLASHDOT LAST UPDATED HERE

# End of R_2_3_0_25

DELETE FROM sections WHERE title='All Sections' OR section='';

ALTER TABLE string_param CHANGE COLUMN name name VARCHAR(64) NOT NULL;

# This is to fix commentcounts -Brian
select concat("UPDATE discussions SET commentcount=", count(cid), " WHERE id=", sid, ";") INTO OUTFILE "/tmp/dis" from comments GROUP BY sid;
source /tmp/dis;
select concat("UPDATE stories SET commentcount=", discussions.commentcount, " WHERE discussion=", id, ";") INTO OUTFILE "/tmp/dis2" from discussions;
source /tmp/dis2;
