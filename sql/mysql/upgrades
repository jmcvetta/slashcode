# This is the upgrade file for SQL. What does this mean to you?
# If you are a developer you should leave notes here as to what
# was done and when. Tihs include inserts, alter tables and deletions.
# The Format is that you add your changes to the end with notes
# and who you are. If your changes occur after a certain release tag
# then you need to place your changes there.
# LCR 2/7, 10PM T_2_3_0_9 

# To fix the data in users to add the + sign to positive values -Brian
UPDATE users_param SET value = CONCAT("+",value) WHERE (name LIKE "reason%" OR name LIKE "people_bonus%") AND value LIKE "_";

# Upgrade Zoo to latest schema, once you do this run the rebuildPeople script 
# in the plugin. -Brian
CREATE TABLE temp_zoo SELECT * FROM people;
DROP TABLE IF EXISTS people;
CREATE TABLE people (
  id MEDIUMINT UNSIGNED NOT NULL auto_increment,
  uid MEDIUMINT UNSIGNED NOT NULL,
  person MEDIUMINT UNSIGNED NOT NULL,
  type enum("friend","foe"),
  perceive enum("fan","freak"),
  fof MEDIUMINT UNSIGNED NOT NULL  DEFAULT 0, 
  eof MEDIUMINT UNSIGNED NOT NULL  DEFAULT 0,
  UNIQUE degree_of_separation (uid,person),
  PRIMARY KEY (id)
);
INSERT INTO people (uid,person,type) SELECT uid, person, type from temp_zoo;


# This was removed from the bonus system a while ago. -Brian
ALTER TABLE users_comments DROP anon_comments;

# Changes for sections
# Make sure you run install-plugin for sections and delete the old sections.pl from your 
# slashcode theme. -Brian
ALTER TABLE sections ADD url char(32) DEFAULT '' NOT NULL;
ALTER TABLE sections ADD hostname char(32)DEFAULT '' NOT NULL;

# Well we didn't need either of these two indexes. We got the same data from two
# other rows. -Brian
ALTER TABLE comments DROP INDEX uid;
ALTER TABLE comments DROP INDEX sid;
# More key stuff. We had a number of duplicate keys in 
# users. I should really spend time and go through the 
# entire schema. -Brian
ALTER TABLE users DROP INDEX login;
ALTER TABLE users ADD INDEX login (nickname,uid,passwd);
ALTER TABLE users DROP INDEX chk4user;
ALTER TABLE users ADD INDEX chk4user (realemail,nickname);
ALTER TABLE users DROP INDEX nickname_lookup;
ALTER TABLE users DROP INDEX chk4email;
# Few more.
ALTER TABLE moderatorlog DROP INDEX sid_2;
ALTER TABLE moderatorlog ADD INDEX sid_2 (cid,uid,sid);
ALTER TABLE moderatorlog DROP INDEX cid;

# new multi topics stuff
DROP TABLE IF EXISTS story_topics;
CREATE TABLE story_topics (
  id int(5) NOT NULL auto_increment,
  sid varchar(16) NOT NULL default '',
  tid smallint(5) unsigned default NULL,
  FOREIGN KEY (sid) REFERENCES stories(sid),
  FOREIGN KEY (tid) REFERENCES topics(tid),
  PRIMARY KEY  (id),
  INDEX sid (sid),
  INDEX tid (tid)
) TYPE=MyISAM;

# New var to regulate comment display - Jamie
INSERT INTO vars (name, value, description) VALUES ('comments_max_email_len','40','Max num of chars of fakeemail to display in comment header');

#______________________________________________________________________
# End of T_2_3_0_10
#______________________________________________________________________
# New attribute for stories
ALTER TABLE stories ADD day_published date DEFAULT '0000-00-00' NOT NULL;
ALTER TABLE stories ADD INDEX published (day_published);
UPDATE stories SET day_published=time;
INSERT INTO vars (name, value, description) VALUES ('comments_moddable_archived','0','Are comments in discussions that have been archived moderatable?');
INSERT INTO vars (name, value, description) VALUES ('comments_moddable_hours','336','Num hours after being posted that a comment may be moderated');
