# This is the upgrade file for SQL. What does this mean to you?
# If you are a developer you should leave notes here as to what
# was done and when. This includes inserts, alter tables and deletions.
# The Format is that you add your changes to the end with notes
# and who you are. If your changes occur after a certain release tag
# then you need to place your changes there.

# BEGIN tf23's additions 
# for required changes to update a site from fry to devel 
# this matches cvs diff -r fry -r T_2_3_0_10 -U3 sql/mysql/slashschema_create.sql
#

ALTER TABLE vars CHANGE name name varchar(48) DEFAULT '' NOT NULL;

ALTER TABLE accesslist CHANGE uid uid mediumint UNSIGNED NOT NULL;

ALTER TABLE blocks ADD rss_template varchar(30);
ALTER TABLE blocks ADD items smallint NOT NULL DEFAULT '0';
ALTER TABLE blocks ADD FOREIGN KEY (rss_template) REFERENCES templates(name);

ALTER TABLE sections ADD FOREIGN KEY (feature_story) REFERENCES stories(sid);

DROP TABLE IF EXISTS story_topics;
CREATE TABLE story_topics (
  id int(5) NOT NULL auto_increment,
  sid varchar(16) NOT NULL default '',
  tid smallint(5) unsigned default NULL,
  FOREIGN KEY (sid) REFERENCES stories(sid),
  FOREIGN KEY (tid) REFERENCES topics(tid),
  PRIMARY KEY (id),
  INDEX tid (tid),
  INDEX sid (sid)
) TYPE = myisam;

DROP TABLE IF EXISTS string_param;
CREATE TABLE string_param (
       param_id smallint UNSIGNED NOT NULL auto_increment,
       type varchar(16) NOT NULL,
       code varchar(16) NOT NULL,
       name varchar(32) NOT NULL,
       UNIQUE code_key (type,code),
       PRIMARY KEY (param_id)
) TYPE = myisam;

DROP TABLE IF EXISTS submission_param;
CREATE TABLE submission_param (
       param_id mediumint UNSIGNED NOT NULL auto_increment,
       subid varchar(15) NOT NULL,
       name varchar(32) DEFAULT '' NOT NULL,
       value text DEFAULT '' NOT NULL,
       UNIQUE submission_key (subid,name),
       PRIMARY KEY (param_id)
) TYPE = myisam;

ALTER TABLE templates ADD COLUMN journal_last_entry_date datetime;

DROP TABLE IF EXISTS users_hits;
CREATE TABLE users_hits (
       uid mediumint UNSIGNED NOT NULL,
       lastclick TIMESTAMP,
       hits int DEFAULT '0' NOT NULL,
       PRIMARY KEY (uid)
) TYPE = myisam;

ALTER TABLE users_index CHANGE COLUMN exsect exsect varchar(255);

ALTER TABLE users_info ADD people blob;

DROP TABLE IF EXISTS temp_zoo;

# END tf23's additions

# (from sometime prior to when we had this file)
ALTER TABLE users_info DROP COLUMN hits;

# LCR 2/7, 10PM T_2_3_0_9 

# To fix the data in users to add the + sign to positive values -Brian
UPDATE users_param SET value = CONCAT("+",value) WHERE (name LIKE "reason%" OR name LIKE "people_bonus%") AND value LIKE "_";

# Upgrade Zoo to latest schema, once you do this run the rebuildPeople script 
# in the plugin. -Brian
CREATE TABLE temp_zoo SELECT * FROM people;
DROP TABLE IF EXISTS people;
CREATE TABLE people (
  id MEDIUMINT UNSIGNED NOT NULL auto_increment,
  uid MEDIUMINT UNSIGNED NOT NULL,
  person MEDIUMINT UNSIGNED NOT NULL,
  type enum("friend","foe"),
  perceive enum("fan","freak"),
  fof MEDIUMINT UNSIGNED NOT NULL  DEFAULT 0, 
  eof MEDIUMINT UNSIGNED NOT NULL  DEFAULT 0,
  UNIQUE degree_of_separation (uid,person),
  PRIMARY KEY (id)
);
INSERT INTO people (uid,person,type) SELECT uid, person, type from temp_zoo;


# This was removed from the bonus system a while ago. -Brian
ALTER TABLE users_comments DROP anon_comments;

# Changes for sections
# Make sure you run install-plugin for sections and delete the old sections.pl from your 
# slashcode theme. -Brian
ALTER TABLE sections ADD url char(32) DEFAULT '' NOT NULL;
ALTER TABLE sections ADD hostname char(32)DEFAULT '' NOT NULL;

# Well we didn't need either of these two indexes. We got the same data from two
# other rows. -Brian
ALTER TABLE comments DROP INDEX uid;
ALTER TABLE comments DROP INDEX sid;
# More key stuff. We had a number of duplicate keys in 
# users. I should really spend time and go through the 
# entire schema. -Brian
ALTER TABLE users DROP INDEX login;
ALTER TABLE users ADD INDEX login (nickname,uid,passwd);
ALTER TABLE users DROP INDEX chk4user;
ALTER TABLE users ADD INDEX chk4user (realemail,nickname);
ALTER TABLE users DROP INDEX nickname_lookup;
ALTER TABLE users DROP INDEX chk4email;
# Few more.
ALTER TABLE moderatorlog DROP INDEX sid_2;
ALTER TABLE moderatorlog ADD INDEX sid_2 (cid,uid,sid);
ALTER TABLE moderatorlog DROP INDEX cid;

# new multi topics stuff
DROP TABLE IF EXISTS story_topics;
CREATE TABLE story_topics (
  id int(5) NOT NULL auto_increment,
  sid varchar(16) NOT NULL default '',
  tid smallint(5) unsigned default NULL,
  FOREIGN KEY (sid) REFERENCES stories(sid),
  FOREIGN KEY (tid) REFERENCES topics(tid),
  PRIMARY KEY  (id),
  INDEX sid (sid),
  INDEX tid (tid)
) TYPE=MyISAM;

# New var to regulate comment display - Jamie
INSERT INTO vars (name, value, description) VALUES ('comments_max_email_len','40','Max num of chars of fakeemail to display in comment header');

# End of T_2_3_0_10, Start of T_2_3_0_11

# New attribute for stories
ALTER TABLE stories ADD day_published date DEFAULT '0000-00-00' NOT NULL;
ALTER TABLE stories ADD INDEX published (day_published);
UPDATE stories SET day_published=time;
INSERT INTO vars (name, value, description) VALUES ('comments_moddable_archived','0','Are comments in discussions that have been archived moderatable?');
INSERT INTO vars (name, value, description) VALUES ('comments_moddable_hours','336','Num hours after being posted that a comment may be moderated');

# End of T_2_3_0_?, Start of R_2_3_0_13

# This was added to sql/mysql/slashschema_create.sql ... but is NOT yet live.
# Brian says "list" is being yanked and "type" is part of code that PatG
# hasn't yet committed, so I'm ignoring it for now... this is here in
# upgrades as a reminder.
# added new column to section_extras to accomodate pulldows 
# (key/values stored in string_param)
ALTER TABLE section_extras add column type enum("text","list") DEFAULT 'text' NOT NULL;
ALTER TABLE string_param modify column code varchar(32) NOT NULL; 

# End of R_2_3_0_13, Start of T_2_3_0_14

ALTER TABLE users_hits ADD COLUMN hits_bought_today SMALLINT UNSIGNED DEFAULT 0 NOT NULL AFTER hits_bought;
ALTER TABLE sessions add column last_subid varchar(15);
ALTER TABLE sessions add column last_sid varchar(16);

# End of R_2_3_0_14, Start of T_2_3_0_15

# add ECODE tag ...
UPDATE vars SET value=CONCAT(value,'|ECODE') WHERE name='approvedtags';

# Message threshold
INSERT INTO vars (name, value, description) VALUES ('message_threshold','1','Default threshold for a comment to trigger a message');

# End of R_2_3_0_15, Start of T_2_3_0_16

# Browser bug workaround
INSERT INTO vars (name, value, description) VALUES ('comment_nonstartwordchars','.,;:/','Chars which cannot start a word (will be forcibly separated from the rest of the word by a space) - this works around a Windows/MSIE "widening" bug - set blank for no action');

# Size changes and new column -Brian
ALTER TABLE sections CHANGE url url varchar(128) DEFAULT '' NOT NULL;
ALTER TABLE sections CHANGE hostname hostname varchar(128) DEFAULT '' NOT NULL;
ALTER TABLE sections ADD cookiedomain varchar(128) DEFAULT '' NOT NULL;
# freshenup.pl chunks article .shtml files
INSERT INTO vars (name, value, description) VALUES ('freshenup_max_stories','100','Maximum number of article.shtml files to write at a time in freshenup.pl');

# Start of T_2_3_0_20

# New hooks table
DROP TABLE IF EXISTS hooks;
CREATE TABLE hooks (
   id mediumint(5) UNSIGNED NOT NULL auto_increment,
   param varchar(50) DEFAULT '' NOT NULL,
   class varchar(100) DEFAULT '' NOT NULL,
   subroutine varchar(100) DEFAULT '' NOT NULL,
   PRIMARY KEY (id),
   UNIQUE hook_param (param,class,subroutine)
) TYPE = myisam;

ALTER TABLE stories ADD COLUMN qid MEDIUMINT UNSIGNED DEFAULT NULL;

# Same as below
#perl -MSlash::Test=virtusername -le '$qs = $slashdb->sqlSelectAllHashrefArray("pollquestions.qid AS qid, pollquestions.sid AS sid", "pollquestions, stories", "pollquestions.sid=stories.sid"); for my $hr (@$qs) { my($q,$s) = ($hr->{qid}, $hr->{sid}); my $sq=$slashdb->sqlQuote($s); print "$q -> $s"; $slashdb->sqlUpdate("stories", { qid => $q }, "sid=$sq") or die "\tFAILED" }'
# I have never tried to do a "source" from a file but I suspect it will work -Brian
select CONCAT('UPDATE stories SET qid=',qid,' WHERE sid="',sid,'";') into outfile "/tmp/pollquestions.sql" from pollquestions;
source /tmp/pollquestions.sql

# (and, once we're convinced everything works)
ALTER TABLE pollquestions DROP COLUMN sid;

# End of T_2_3_0_20, Start of T_2_3_0_21

# New submission_param table
DROP TABLE IF EXISTS submission_param;
CREATE TABLE submission_param (
   param_id mediumint UNSIGNED NOT NULL auto_increment,
   subid varchar(15) NOT NULL,
   name varchar(32) DEFAULT '' NOT NULL,
   value text DEFAULT '' NOT NULL,
   UNIQUE submission_key (subid,name),
   PRIMARY KEY (param_id)
) TYPE = myisam;

# This is the multi section topic stuff for Foundries
INSERT INTO code_param (type, code, name) VALUES ('section_topic_types',1,'default');
ALTER TABLE section_topics ADD COLUMN type smallint UNSIGNED NOT NULL;
UPDATE section_topics SET type=1;

ALTER TABLE section_extras MODIFY COLUMN type ENUM("text","list","topics") DEFAULT 'text' NOT NULL;

# Autopoll update
ALTER TABLE pollquestions ADD COLUMN autopoll enum("no","yes") DEFAULT 'no' NOT NULL;

# Submissions
ALTER TABLE submissions ADD COLUMN weight float DEFAULT '0' NOT NULL;

#New index_handler bits
INSERT INTO vars (name, value, description) VALUES ('index_handler','index.pl','The perl servlet to call for conections to the root of the server.');
ALTER TABLE sections ADD COLUMN index_handler varchar(30) DEFAULT "index.pl" NOT NULL;
ALTER TABLE sections ADD COLUMN writestatus ENUM("ok","dirty") DEFAULT 'ok' NOT NULL;

#slashd_log table
INSERT INTO menus (menu, label, value, seclev, menuorder) VALUES ('admin','Slashd','[% constants.rootdir %]/admin.pl?op=slashd',500,17);

# Note this is different than what Brian committed Wednesday morning;
# were any sites updated with that?
DROP TABLE IF EXISTS slashd_status;
CREATE TABLE slashd_status (
   task varchar(50) NOT NULL default '',
   next_begin DATETIME,
   in_progress TINYINT NOT NULL DEFAULT '0',
   last_completed DATETIME,
   summary VARCHAR(255) NOT NULL DEFAULT '',
   duration float(6,2) DEFAULT '0.00' NOT NULL,
   PRIMARY KEY  (task)
) TYPE=MyISAM;

# Remember pollBooth is now a plugin!

# Unique changes for Pat
ALTER TABLE section_topics DROP PRIMARY KEY;
ALTER TABLE section_topics ADD PRIMARY KEY (section,type,tid);
INSERT INTO string_param (type, code, name) VALUES ('yes_no','yes','yes');
INSERT INTO string_param (type, code, name) VALUES ('yes_no','no','no');
INSERT INTO vars (name, value, description) VALUES ('label_ui','0','Whether to label some things in the admin ui');
INSERT INTO vars (name, value, description) VALUES ('enable_index_topic','','set this to the value in string param for index topic \(something like "topic_4"\)');
INSERT INTO vars (name, value, description) VALUES ('get_titles','0','get the story titles');
INSERT INTO vars (name, value, description) VALUES ('organise_stories','','organise story blocks');
INSERT INTO string_param (Type, code, name) VALUES ('section_topic_type','topic_1','Default');

# another small change for topic types
ALTER TABLE section_topics MODIFY COLUMN type varchar(16) NOT NULL DEFAULT 'topic_1';
UPDATE section_topics SET type = 'topic_1' WHERE type = '1';

# Change for plugins/Subscribe (ignore if not using that plugin)
ALTER TABLE subscribe_payments ADD COLUMN method VARCHAR(6) AFTER transaction_id;

ALTER TABLE comments DROP index countreplies;
ALTER TABLE comments ADD KEY countreplies (pid,sid);
# Not read just yet but I am leaving it here as a note -Brian
ALTER TABLE blocks ADD autosubmit enum("no","yes") DEFAULT 'no' NOT NULL;
INSERT INTO vars (name, value, description) VALUES ('rss_store','0','Should we be saving incomming submissions for rss');
INSERT INTO vars (name, value, description) VALUES ('rss_expire_days','7','Number of days till we blank the data from the database (the signatures still stick around though)');
ALTER TABLE submissions DROP subid;
ALTER TABLE submissions ADD subid mediumint UNSIGNED NOT NULL PRIMARY KEY auto_increment;
ALTER TABLE sessions DROP last_subid;
ALTER TABLE sessions ADD last_subid mediumint UNSIGNED;
DROP TABLE IF EXISTS submission_param;
CREATE TABLE submission_param (
   param_id mediumint UNSIGNED NOT NULL auto_increment,
   subid mediumint UNSIGNED NOT NULL,
   name varchar(32) DEFAULT '' NOT NULL,
   value text DEFAULT '' NOT NULL,
   UNIQUE submission_key (subid,name),
   PRIMARY KEY (param_id)
) TYPE = myisam;
DROP TABLE IF EXISTS rss_raw;
CREATE TABLE rss_raw (
   id mediumint UNSIGNED NOT NULL auto_increment,
   link_signature char(32) DEFAULT '' NOT NULL,
   title_signature char(32) DEFAULT '' NOT NULL,
   description_signature char(32) DEFAULT '' NOT NULL,
   link varchar(255) NOT NULL,
   title varchar(255) NOT NULL,
   description varchar(255) NOT NULL,
   subid mediumint UNSIGNED,
   bid varchar(30),
   created datetime, 
   processed enum("no","yes") DEFAULT 'no' NOT NULL,
   UNIQUE uber_signature (link_signature, title_signature, description_signature),
   FOREIGN KEY (subid) REFERENCES submissions(subid),
   FOREIGN KEY (bid) REFERENCES blocks(bid),
   PRIMARY KEY (id)
) TYPE = myisam;

# A nice useful var.
INSERT INTO vars (name, value, description) VALUES ('admin_formkeys', '0', 'Do admins have to bother with formkeys?');

# End of T_2_3_0_21, Start of T_2_3_0_22

# Install GD.pm and associated libraries for plugins/HumanConf.
# GD/Text and GD/Text/Align.pm are needed too.
# These Debian packages are believed necessary:
# libfreetype6-dev libfreetype6 freetype2 libjpeg62-dev libjpeg62
# when building from source, I used freetype-2.1.0, libpng-1.2.2,
# jpeg-6b, and gd-1.8.4, and the GD module from the CPAN. -- pudge
# last night Cliff and I got it to work on Debian stable using
# libjpeg62(-dev) and xpm4g(-dev) debs, plus source compiles of
# freetype-2.1.0 and gd-1.8.4; GD had 1 error (#8) and GD::Text
# had several errors, but after force installing, they work OK
# for HumanConf purposes.

# Add signature column to submissions. Be aware that this column's final
# state does not have a default.
ALTER TABLE submissions ADD COLUMN signature varchar(32) DEFAULT '' NOT NULL;
ALTER TABLE submissions ADD UNIQUE story_signature(signature);
UPDATE submissions SET signature=MD5(story);
ALTER TABLE submissions MODIFY COLUMN signature varchar(32) NOT NULL;

# This expands blocks to get data from sites that require logins via a cookie
ALTER TABLE blocks ADD COLUMN rss_cookie varchar(255);

#We ran into URLs that were longer then 50 characters 
ALTER TABLE submissions MODIFY COLUMN email varchar(255) DEFAULT '' NOT NULL;

UPDATE vars SET value=100 WHERE name="authors_unlimited";

#Needed for search, not used in submissions "yet"
INSERT INTO string_param (type, code, name) VALUES ('submission-notes','','Unclassified');
INSERT INTO string_param (type, code, name) VALUES ('submission-notes','Hold','Hold');
INSERT INTO string_param (type, code, name) VALUES ('submission-notes','Quick','Quick');
INSERT INTO string_param (type, code, name) VALUES ('submission-notes','Back','Back');

#
# Table structure for table 'subsections'
#

DROP TABLE IF EXISTS subsections;
CREATE TABLE subsections (
  id smallint UNSIGNED NOT NULL auto_increment,
  title varchar(30) NOT NULL,
  section varchar(30) NOT NULL,
  artcount mediumint DEFAULT '30' NOT NULL,
  UNIQUE code_key (title,section),
  FOREIGN KEY (section) REFERENCES sections(section),
  PRIMARY KEY (id)
) TYPE = myisam;

# End of T_2_3_0_22, Start of T_2_3_0_23

# If using HumanConf...
ALTER TABLE humanconf_pool ADD COLUMN inuse TINYINT DEFAULT '0' NOT NULL AFTER lastused;

ALTER TABLE stories ADD subsection SMALLINT UNSIGNED DEFAULT 0 NOT NULL;
ALTER TABLE sections DROP feature_story;
ALTER TABLE accesslog ADD bytes mediumint UNSIGNED DEFAULT 0 NOT NULL;
INSERT INTO message_codes (code, type, seclev, modes) VALUES (10, 'Daily Site Stats', 100, '');

ALTER TABLE discussions ADD last_update timestamp;
ALTER TABLE stories ADD last_update timestamp;

# End of R_2_3_0_23, Start of T_2_3_0_25
# (we skipped _24 due to an earlier glitch)

INSERT INTO vars (name, value, description) VALUES ('recent_topic_img_count','5','Number of recent topics to store in the template "recentTopics"');
INSERT INTO vars (name, value, description) VALUES ('recent_topic_txt_count','5','Number of recent topics to store in the block "recenttopics"');

INSERT INTO code_param (type, code, name) VALUES ('displaycodes_sectional', -1,'Don\'t Display');
INSERT INTO code_param (type, code, name) VALUES ('displaycodes_sectional', 1,'Display');
INSERT INTO vars (name, value, description) VALUES ('discussion_sort_order', '3', 'sort code to feed to findDiscussions');


# For plugins/Admin (ignore if not using that plugin)
INSERT INTO vars (name, value, description) VALUES ('similarstorydays', '30', 'Number of days to look back for uncommon words');
INSERT INTO vars (name, value, description) VALUES ('similarstorymaxwords', '30', 'Maximum number of top-weighted scores to search for in previous stories');
INSERT INTO vars (name, value, description) VALUES ('similarstoryminweight', '4', 'Minimum weight necessary for a story to be displayed as similar');
INSERT INTO vars (name, value, description) VALUES ('similarstorynumshow', '5', 'Maximum number of similar stories to show in admin preview');
INSERT INTO vars (name, value, description) VALUES ('uncommonstorywords', '', 'Uncommon words found in recent stories');
INSERT INTO vars (name, value, description) VALUES ('uncommonstorywords_maxlen', '65000', 'Maximum length of the uncommon words list');
INSERT INTO vars (name, value, description) VALUES ('uncommonstoryword_minlen', '3', 'Minimum length of the words in the uncommon words list');
INSERT INTO vars (name, value, description) VALUES ('uncommonstoryword_thresh', '2', 'Words occurring more often than once every this-many days are considered common');

# and this is not a DB command but needs to be done for
# each installed site that uses plugins/Admin:
# ln -s /usr/local/slash/plugins/Admin/refresh_uncommon.pl /usr/local/slash/site/sitename/tasks/

# Added for Pat for discussions -Brian
ALTER TABLE discussions ADD approved tinyint UNSIGNED DEFAULT 0 NOT NULL;
INSERT INTO vars (name, value, description) VALUES ('discussion_approval', '0', 'If this is set to 1, set all user created discussions when created to 0 so that they must be approved');
# For pudge -brian
ALTER TABLE templates ADD last_update timestamp;


# Added for some Calendar stuff I am working on -Brian
INSERT INTO code_param (type, code, name) VALUES ('months',1,'January');
INSERT INTO code_param (type, code, name) VALUES ('months',2,'Febuary');
INSERT INTO code_param (type, code, name) VALUES ('months',3,'March');
INSERT INTO code_param (type, code, name) VALUES ('months',4,'April');
INSERT INTO code_param (type, code, name) VALUES ('months',5,'May');
INSERT INTO code_param (type, code, name) VALUES ('months',6,'June');
INSERT INTO code_param (type, code, name) VALUES ('months',7,'July');
INSERT INTO code_param (type, code, name) VALUES ('months',8,'August');
INSERT INTO code_param (type, code, name) VALUES ('months',9,'September');
INSERT INTO code_param (type, code, name) VALUES ('months',10,'October');
INSERT INTO code_param (type, code, name) VALUES ('months',11,'November');
INSERT INTO code_param (type, code, name) VALUES ('months',12,'December');

# End of R_2_3_0_25, start of T_2_3_0_26

DELETE FROM sections WHERE title='All Sections' OR section='';

ALTER TABLE string_param CHANGE COLUMN name name VARCHAR(64) NOT NULL;

# This is to fix commentcounts -Brian
select concat("UPDATE discussions SET commentcount=", count(cid), " WHERE id=", sid, ";") INTO OUTFILE "/tmp/dis" from comments GROUP BY sid;
source /tmp/dis;
select concat("UPDATE stories SET commentcount=", discussions.commentcount, " WHERE discussion=", id, ";") INTO OUTFILE "/tmp/dis2" from discussions;
source /tmp/dis2;


ALTER TABLE pollanswers CHANGE COLUMN qid qid MEDIUMINT UNSIGNED NOT NULL;

ALTER TABLE formkeys CHANGE COLUMN formname formname varchar(32) DEFAULT '' NOT NULL;

# End of R_2_3_0_27, Start of T_2_3_0_28

ALTER TABLE vars CHANGE COLUMN name name varchar(48) DEFAULT '' NOT NULL;
INSERT INTO vars (name, value, description) VALUES ('lonetags','P|LI|BR|IMG','Tags that don\'t need to be closed');

INSERT INTO vars (name, value, description) VALUES ('top10comm_num','10','Number of comments wanted for the Top 10 Comments slashbox (if not 10, you ought to rename it maybe)');
INSERT INTO vars (name, value, description) VALUES ('anon_name_alt','An anonymous coward','Name of anonymous user to be displayed in stories');

# End of T_2_3_0_28, Start of T_2_3_0_29

INSERT INTO vars (name, value, description) VALUES ('karma_adj','-10=Terrible|-1=Bad|0=Neutral|12=Positive|25=Good|99999=Excellent','Adjectives that describe karma, used if karma_obfuscate is set (best to keep aligned with badkarma, m2_maxbonus, and goodkarma)');
INSERT INTO vars (name, value, description) VALUES ('karma_obfuscate','0','Should users see, not their numeric karma score, but instead an adjective describing their approximate karma?');

#Section stuff -Brian
ALTER TABLE sections ADD type ENUM("contained", "collected") DEFAULT 'contained' NOT NULL;
UPDATE sections SET type="contained";
INSERT INTO vars (name, value, description) VALUES ('section','index','This is the current setting for section.');
INSERT INTO sections (section, artcount, title, qid, isolate, issue, extras, type) VALUES ('index',15,'Index','',0,0,0,'collected');
ALTER TABLE blocks ADD all_sections tinyint NOT NULL DEFAULT '0';
UPDATE blocks SET all_sections=1 WHERE section="all_sections";
UPDATE blocks SET section="index" WHERE section="all_sections";
INSERT INTO vars (name, value, description) VALUES ('draconian_charrefs','0','Enable strictest-possible rules for disallowing HTML entities/character references?');

# Let's not forget to put the sections_contained table in the upgrades file
# once it becomes appropriate to do so.

# Forgot this one a little while ago I think.
INSERT INTO vars (name, value, description) VALUES ('approved_url_schemes','ftp|http|gopher|mailto|news|nntp|telnet|wais|https','Schemes that can be used in comment links without being stripped of bogus chars');


# End of T_2_3_0_29, Start of T_2_3_0_30

# OSDNTEST LAST UPDATED HERE
# OSDN LAST UPDATED HERE

# Forgot this one a little while ago too.
# For plugins/Stats (ignore if you're not using that plugin):
INSERT INTO vars (name, value, description) VALUES ('mod_stats','1','Include stats on moderation in the daily admin mail?');

# End of R_2_3_0_30, Start of T_2_3_0_31

DROP TABLE IF EXISTS sections_contained;
CREATE TABLE sections_contained (
  id SMALLINT UNSIGNED NOT NULL auto_increment,
  container varchar(30) NOT NULL,
  section varchar(30) NOT NULL,
  UNIQUE (container,section),
  FOREIGN KEY (container) REFERENCES sections(section),
  FOREIGN KEY (section) REFERENCES sections(section),
  PRIMARY KEY (id)
) TYPE = myisam;
ALTER TABLE sections ADD rewrite mediumint UNSIGNED DEFAULT '3600' NOT NULL;
ALTER TABLE sections ADD last_update timestamp;

# For plugins/Email ONLY (LC, Slashcode, etc -- NOT SLASHDOT!)
INSERT INTO message_codes (code, type, seclev, modes) VALUES (11, 'Email Story', 1, 0);

# End of R_2_3_0_31, Start of T_2_3_0_32

INSERT INTO vars (name, value, description) VALUES ('comments_perday_bykarma','-1=2|25=25|99999=50','Number of comments allowed to be posted per day, by karma score.');
INSERT INTO vars (name, value, description) VALUES ('comments_perday_anon','10','Number of comments allowed to be posted per day, by any one IPID, anonymously.');

# End of R_2_3_0_32, Start of T_2_3_0_33

INSERT INTO vars (name, value, description) VALUES ('users_bio_length','1024','Length allowed for user bio');

INSERT INTO vars (name, value, description) VALUES ('submit_forgetip_hours','720','Hours after which a submissions\'s ipid/subnetid are forgotten; set very large to disable');
INSERT INTO vars (name, value, description) VALUES ('submit_forgetip_maxrows','100000','Max number of rows to forget IPs of at once');
INSERT INTO vars (name, value, description) VALUES ('submit_forgetip_minsubid','0','Minimum subid to start forgetting IP at');

# End of T_2_3_0_34, Start of T_2_3_0_35

ALTER TABLE sections DROP isolate;

# For plugins/Stats (ignore if you're not using that plugin):
INSERT INTO vars (name, value, description) VALUES ('db_slave_lag_ignore',10000000,'Bytes of lag between master and slave DB to ignore');

# End of T_2_3_0_35, Start of T_2_3_0_36

# For Sections
INSERT INTO string_param (type, code, name) VALUES ('section_types','contained','Contained Section');
INSERT INTO string_param (type, code, name) VALUES ('section_types','collected','Collection of Sections');

SELECT concat("UPDATE sections SET qid=", value," WHERE section='index';") INTO OUTFILE "/tmp/qidproblem" from vars WHERE name="currentqid";
source /tmp/qidproblem;

# LINUX.COM LAST UPDATED HERE

# For plugins/Admin (ignore if you're not using that plugin):
INSERT INTO menus (menu, label, value, seclev, menuorder) VALUES ('admin','Recent','[% constants.rootdir %]/admin.pl?op=recent',500,18);

INSERT INTO code_param (type, code, name) VALUES ('displaycodes_sectional', -1,'Don\'t Display');
INSERT INTO code_param (type, code, name) VALUES ('displaycodes_sectional', 1,'Display');
INSERT INTO vars (name, value, description) VALUES ('discussion_sort_order', '3', 'sort code to feed to findDiscussions');

# For plugins/Stats (ignore if you're not using that plugin):
INSERT INTO vars (name, value, description) VALUES ('tailslash_stats','1','true/false log tailslash in adminmail');

# column truncated descriptions fields
ALTER TABLE rss_raw modify column description text;

# For plugins/Stats (ignore if you're not using that plugin):
ALTER TABLE stats_daily DROP INDEX day_key_pair;
ALTER TABLE stats_daily ADD COLUMN section varchar(30) DEFAULT 'index' NOT NULL;
ALTER TABLE stats_daily ADD UNIQUE day_key_pair (day,name,section);
ALTER TABLE stats_daily ADD FOREIGN KEY (section) REFERENCES sections(section);

# For plugins/Stats (ignore if you're not using that plugin):
INSERT INTO vars (name, value, description) VALUES ('op_exclude_from_countdaily','rss','Ops to omit from daily counts in adminmail');
INSERT INTO vars (name, value, description) VALUES ('mod_stats_min_repeat','2','Minimum number repeat mods to appear in mod stats');

INSERT INTO vars (name, value, description) VALUES ('cookiesecure','1','Set the secure flag in cookies if SSL is on?');

# Need a CPAN install of Date::Calc and XML::Simple!

# End of T_2_3_0_36

# USEPERL LAST UPDATED HERE
# FOUNDRIES TEST SITE LAST UPDATED HERE
# SLASHCODE LAST UPDATED HERE
# SLASHDOT LAST UPDATED HERE

# from foundries integrations
ALTER TABLE string_param MODIFY COLUMN code varchar(128) NOT NULL;
ALTER TABLE menus MODIFY COLUMN label varchar(255) DEFAULT '' NOT NULL;
ALTER TABLE rss_raw MODIFY COLUMN description text;
ALTER TABLE section_extras MODIFY COLUMN type enum("text","list","topics") DEFAULT 'text' NOT NULL;
# For submissions notes -Brian
INSERT INTO code_param (type, code, name) VALUES ('submission-state',0,'Pending');
INSERT INTO code_param (type, code, name) VALUES ('submission-state',1,'Rejected');
INSERT INTO code_param (type, code, name) VALUES ('submission-state',2,'Accepted');

# For plugins/Repository (ignore if you're not using that plugin):
DELETE FROM templates WHERE name='listRepository' AND page='repository' AND section='default';
# (this template was renamed; the new "listRepos" will be added back
# in with a "template-tool -U")

